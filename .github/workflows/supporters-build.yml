name: Build grzyClothTool for supporters

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.400'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --verbosity detailed

      - name: Publish application
        run: |
          dotnet publish -c Release -r win-x64 --self-contained false --output ./publish \
          /p:PublishSingleFile=true \
          /p:PublishReadyToRun=true \
          /p:TargetFramework=net8.0-windows

      - name: Create Zip
        run: |
          cd publish
          powershell Compress-Archive -Path * -DestinationPath ../grzyClothTool-supporters.zip

      - name: Send Discord Notification
        run: |
          # Prepare the zip file path and Discord webhook URL
          $zipFilePath = "grzyClothTool-supporters.zip"
          $webhookUrl = "${{ secrets.DISCORD_WEBHOOK }}"

          # Create the JSON payload
          $jsonPayload = @{
            username = "GitHub"
            content = "Hello"
            embeds = @(
              @{
                type = "rich"
                title = "Build Status Update"
                description = "âœ… Build grzyClothTool succeeded! Here's the build zip:"
                color = 2123412
                thumbnail = @{
                  url = "https://avatars.githubusercontent.com/u/160980408?v=4"
                }
                author = @{
                  name = "${{ github.actor }}"
                  url = "https://github.com/${{ github.actor }}"
                  icon_url = "https://avatars.githubusercontent.com/u/${{ github.actor_id }}?v=4"
                }
                url = "https://github.com/grzybeek/grzyClothTool"  # Change to your repository URL
                fields = @(
                  @{
                    name = "Download Build Zip"
                    value = "[grzyClothTool-supporters.zip](attachment://grzyClothTool-supporters.zip)"
                  }
                )
              }
            )
          } | ConvertTo-Json

          # Send the message with the zip file
          curl -X POST $webhookUrl -F "payload_json=$jsonPayload" -F "file=@$zipFilePath"
